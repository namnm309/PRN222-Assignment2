@page
@model PresentationLayer.Pages.DealerManager.Orders.CreateModel
@{
	Layout = "/Pages/Shared/_DashboardLayout.cshtml";
	ViewData["Title"] = "T·∫°o b√°o gi√° m·ªõi";
}

<div class="container-fluid">
	<!-- Header -->
	<div class="mb-4">
		<nav aria-label="breadcrumb" class="mb-3">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a asp-page="/DealerManager/Index">Dashboard</a></li>
				<li class="breadcrumb-item"><a asp-page="/DealerManager/Orders/Index">ƒê∆°n h√†ng</a></li>
				<li class="breadcrumb-item active">T·∫°o b√°o gi√°</li>
			</ol>
		</nav>
		<h3 class="fw-bold"><i class="fas fa-file-invoice-dollar me-2 text-primary"></i>T·∫°o b√°o gi√° m·ªõi</h3>
		<p class="text-muted">T·∫°o b√°o gi√° cho kh√°ch h√†ng</p>
	</div>

	<div class="row">
		<div class="col-lg-8">
			<div class="card border-0 shadow-sm">
				<div class="card-header bg-white border-0 py-3">
					<h5 class="mb-0"><i class="fas fa-edit me-2"></i>Th√¥ng tin b√°o gi√°</h5>
				</div>
				<div class="card-body">
					<form method="post" id="quotationForm">
						<div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
						
						<!-- Step 1: Customer & Product -->
						<div class="mb-4">
							<h6 class="text-muted mb-3"><i class="fas fa-info-circle me-2"></i>B∆∞·ªõc 1: Ch·ªçn s·∫£n ph·∫©m v√† kh√°ch h√†ng</h6>
							<div class="row g-3">
								<div class="col-md-6">
									<label class="form-label fw-semibold">
										<i class="fas fa-car me-1 text-primary"></i>S·∫£n ph·∫©m
										<span class="text-danger">*</span>
									</label>
									<select asp-for="Input.ProductId" class="form-select form-select-lg" required id="productSelect" onchange="loadProductInfo()">
										<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
										@foreach (var p in Model.Products)
										{
											<option value="@p.Id" data-price="@p.Price" data-stock="@p.StockQuantity">@p.Name - @p.Sku (@p.Price.ToString("N0") VND)</option>
										}
									</select>
									<span asp-validation-for="Input.ProductId" class="text-danger small"></span>
									<div id="stock-alert" class="mt-2" style="display: none;">
										<!-- Stock info will be displayed here -->
									</div>
								</div>
								<div class="col-md-6">
									<label class="form-label fw-semibold">
										<i class="fas fa-user me-1 text-info"></i>Kh√°ch h√†ng
										<span class="text-danger">*</span>
									</label>
									<select asp-for="Input.CustomerId" class="form-select form-select-lg" required>
										<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
										@foreach (var c in Model.Customers)
										{
											<option value="@c.Id">@c.FullName - @c.PhoneNumber</option>
										}
									</select>
									<span asp-validation-for="Input.CustomerId" class="text-danger small"></span>
								</div>
							</div>
						</div>

						<!-- Step 2: Pricing -->
						<div class="mb-4">
							<h6 class="text-muted mb-3"><i class="fas fa-dollar-sign me-2"></i>B∆∞·ªõc 2: ƒê·ªãnh gi√°</h6>
							<div class="row g-3">
								<div class="col-md-6">
									<label class="form-label fw-semibold">
										<i class="fas fa-tag me-1 text-success"></i>Gi√° b√°n (VND)
										<span class="text-danger">*</span>
									</label>
									<input asp-for="Input.Price" class="form-control form-control-lg" type="number" id="price" oninput="calcTotal()" placeholder="0" />
									<span asp-validation-for="Input.Price" class="text-danger small"></span>
								</div>
								<div class="col-md-6">
									<label class="form-label fw-semibold">
										<i class="fas fa-percent me-1 text-warning"></i>Gi·∫£m gi√° (VND)
									</label>
									<input asp-for="Input.Discount" class="form-control form-control-lg" type="number" id="discount" oninput="calcTotal()" placeholder="0" />
									<span asp-validation-for="Input.Discount" class="text-danger small"></span>
								</div>
							</div>
						</div>

						<!-- Step 3: Additional Info -->
						<div class="mb-4">
							<h6 class="text-muted mb-3"><i class="fas fa-clipboard me-2"></i>B∆∞·ªõc 3: Th√¥ng tin b·ªï sung</h6>
							<div class="row g-3">
								<div class="col-md-12">
									<label class="form-label fw-semibold">
										<i class="fas fa-user-tie me-1 text-primary"></i>Nh√¢n vi√™n b√°n h√†ng
									</label>
									<select asp-for="Input.SalesPersonId" class="form-select">
										<option value="">-- Kh√¥ng ch·ªçn --</option>
										@foreach (var s in Model.Staff)
										{
											<option value="@s.Id">@s.FullName - @s.Email</option>
										}
									</select>
								</div>
								<div class="col-md-12">
									<label class="form-label fw-semibold">
										<i class="fas fa-align-left me-1"></i>M√¥ t·∫£
									</label>
									<textarea asp-for="Input.Description" class="form-control" rows="3" placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt v·ªÅ ƒë∆°n h√†ng..."></textarea>
								</div>
								<div class="col-md-12">
									<label class="form-label fw-semibold">
										<i class="fas fa-sticky-note me-1"></i>Ghi ch√∫
									</label>
									<textarea asp-for="Input.Notes" class="form-control" rows="2" placeholder="Ghi ch√∫ th√™m n·∫øu c√≥..."></textarea>
								</div>
							</div>
						</div>

						<!-- Actions -->
						<div class="d-flex gap-2 justify-content-end">
							<a asp-page="/DealerManager/Orders/Index" class="btn btn-lg btn-outline-secondary">
								<i class="fas fa-times me-1"></i>H·ªßy
							</a>
							<button type="submit" class="btn btn-lg btn-primary">
								<i class="fas fa-save me-1"></i>T·∫°o b√°o gi√°
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<!-- Summary Card -->
		<div class="col-lg-4">
			<div class="card border-0 shadow-sm sticky-top" style="top: 80px;">
				<div class="card-header bg-white border-0 py-3">
					<h5 class="mb-0"><i class="fas fa-calculator me-2"></i>T·ªïng quan</h5>
				</div>
				<div class="card-body">
					<div class="mb-3 pb-3 border-bottom">
						<div class="d-flex justify-content-between mb-2">
							<span class="text-muted">Gi√° b√°n:</span>
							<strong id="priceDisplay">0 VND</strong>
						</div>
						<div class="d-flex justify-content-between mb-2">
							<span class="text-muted">Gi·∫£m gi√°:</span>
							<strong class="text-danger" id="discountDisplay">0 VND</strong>
						</div>
					</div>
					<div class="d-flex justify-content-between align-items-center p-3 rounded" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
						<div class="text-white">
							<div class="small opacity-75">Th√†nh ti·ªÅn</div>
							<h3 class="mb-0 fw-bold" id="totalDisplay">0 VND</h3>
						</div>
						<i class="fas fa-money-bill-wave text-white fs-1 opacity-50"></i>
					</div>
				</div>
				<div class="card-footer bg-white border-0">
					<div class="d-grid">
						<button type="submit" form="quotationForm" class="btn btn-primary btn-lg">
							<i class="fas fa-check me-2"></i>X√°c nh·∫≠n t·∫°o b√°o gi√°
						</button>
					</div>
				</div>
			</div>

			<!-- Help Card -->
			<div class="card border-0 shadow-sm mt-3">
				<div class="card-body">
					<h6 class="fw-semibold mb-3"><i class="fas fa-lightbulb me-2 text-warning"></i>G·ª£i √Ω</h6>
					<ul class="small text-muted mb-0 ps-3">
						<li>Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn gi√°</li>
						<li>Gi·∫£m gi√° c√≥ th·ªÉ ƒë·ªÉ tr·ªëng (m·∫∑c ƒë·ªãnh = 0)</li>
						<li>Th√™m nh√¢n vi√™n ƒë·ªÉ theo d√µi hi·ªáu su·∫•t</li>
						<li>Ghi ch√∫ gi√∫p nh·ªõ chi ti·∫øt ƒë∆°n h√†ng</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	// Auto-fill price when product selected
	document.getElementById('productSelect').addEventListener('change', function() {
		const selectedOption = this.options[this.selectedIndex];
		const price = selectedOption.getAttribute('data-price');
		if (price) {
			document.getElementById('price').value = price;
			calcTotal();
		}
	});

	function calcTotal() {
		const price = parseFloat(document.getElementById('price').value) || 0;
		const discount = parseFloat(document.getElementById('discount').value) || 0;
		const total = price - discount;
		
		document.getElementById('priceDisplay').innerText = price.toLocaleString('vi-VN') + ' VND';
		document.getElementById('discountDisplay').innerText = discount.toLocaleString('vi-VN') + ' VND';
		document.getElementById('totalDisplay').innerText = total.toLocaleString('vi-VN') + ' VND';
	}
	
	function loadProductInfo() {
		const productSelect = document.getElementById('productSelect');
		const selectedOption = productSelect.options[productSelect.selectedIndex];
		
		if (selectedOption.value) {
			const price = selectedOption.dataset.price;
			const stock = selectedOption.dataset.stock;
			
			document.getElementById('price').value = price;
			calcTotal();
			
			// Check stock availability
			checkProductStock(selectedOption.value);
		} else {
			document.getElementById('stock-alert').style.display = 'none';
		}
	}

	// Function to check product stock via AJAX
	function checkProductStock(productId) {
		var stockAlert = document.getElementById('stock-alert');
		
		// Show loading
		stockAlert.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> ƒêang ki·ªÉm tra t·ªìn kho...';
		stockAlert.style.display = 'block';
		
		fetch(`/DealerManager/Orders/Create?handler=GetProductStock&productId=${productId}`)
			.then(response => response.json())
			.then(data => {
				if (!data.success) {
					stockAlert.innerHTML = '<div class="alert alert-danger mb-0"><i class="fas fa-exclamation-circle"></i> ' + data.message + '</div>';
					return;
				}

				if (data.availableQuantity <= 0) {
					stockAlert.innerHTML = `
						<div class="alert alert-warning mb-0">
							<i class="fas fa-exclamation-triangle"></i> ${data.message}
							<br><small>B·∫°n c√≥ th·ªÉ ƒë·∫∑t h√†ng t·ª´ h√£ng t·∫°i menu <strong>"ƒê·∫∑t xe t·ª´ h√£ng"</strong></small>
						</div>`;
				} else if (data.isEVMStock) {
					// T·ªìn kho EVM (ch∆∞a ph√¢n b·ªï cho ƒë·∫°i l√Ω)
					stockAlert.innerHTML = `
						<div class="alert alert-info mb-0">
							<i class="fas fa-info-circle"></i> ${data.message}
							<br><small class="text-info">üí° ƒê√¢y l√† t·ªìn kho EVM. Li√™n h·ªá EVM ƒë·ªÉ ph√¢n b·ªï cho ƒë·∫°i l√Ω.</small>
						</div>`;
				} else if (data.availableQuantity < 5) {
					stockAlert.innerHTML = `
						<div class="alert alert-warning mb-0">
							<i class="fas fa-warehouse"></i> ${data.message}
							<br><small>‚ö†Ô∏è T·ªìn kho th·∫•p! H√£y li√™n h·ªá EVM ƒë·ªÉ b·ªï sung h√†ng.</small>
						</div>`;
				} else {
					// T·ªìn kho ƒë√£ ph√¢n b·ªï cho ƒë·∫°i l√Ω
					stockAlert.innerHTML = `
						<div class="alert alert-success mb-0">
							<i class="fas fa-check-circle"></i> ${data.message}
							<br><small>ƒê√£ ph√¢n b·ªï: ${data.allocatedQuantity} | ƒê√£ ƒë·∫∑t: ${data.reservedQuantity}</small>
						</div>`;
				}
			})
			.catch(error => {
				stockAlert.innerHTML = '<div class="alert alert-danger mb-0"><i class="fas fa-times-circle"></i> Kh√¥ng th·ªÉ ki·ªÉm tra t·ªìn kho</div>';
			});
	}

	// Initialize
	calcTotal();
</script>

<style>
	.form-control-lg, .form-select-lg {
		font-size: 1rem;
		padding: 0.75rem;
	}
	
	.card {
		transition: box-shadow 0.3s ease;
	}
	
	.card:hover {
		box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.1) !important;
	}
</style>
