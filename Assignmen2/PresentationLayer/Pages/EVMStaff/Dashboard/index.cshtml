@page "/EVMStaff/Dashboard"
@model PresentationLayer.Pages.EVMStaff.Dashboard.IndexModel
@{
    Layout = "~/Pages/Shared/_DashboardLayout.cshtml";
    ViewData["Title"] = "EVM Staff Dashboard";
}

<!-- Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body text-white p-4">
                <div class="d-flex align-items-center justify-content-between">
    <div>
                        <h2 class="mb-2 fw-bold">Chào mừng, @Model.CurrentUserName</h2>
                        <p class="mb-0 opacity-75 vn-date"><i class="fas fa-shield-alt me-2"></i>EVM Staff Dashboard - Tổng quan hệ thống</p>
                    </div>
                    <div class="text-end">
                        <div class="fs-5 fw-semibold">@DateTime.Now.ToString("dddd, dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN"))</div>
                        <div class="small opacity-75">@DateTime.Now.ToString("HH:mm")</div>
                    </div>
                </div>
            </div>
    </div>
    </div>
</div>

<!-- Alert Messages -->
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>@TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- KPI Cards -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-md-6">
        @{
            ViewData["Title"] = "Tổng sản phẩm";
            ViewData["Value"] = Model.TotalProducts.ToString();
            ViewData["Unit"] = "Sản phẩm";
            ViewData["IconClass"] = "fas fa-car";
            ViewData["GradientClass"] = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
            ViewData["ProgressPercent"] = 75;
            ViewData["SubText"] = "<i class=\"fas fa-arrow-up me-1\"></i>Đang kinh doanh";
        }
        <partial name="_KpiCard" />
    </div>

    <div class="col-xl-3 col-md-6">
        @{
            ViewData["Title"] = "Tổng đại lý";
            ViewData["Value"] = Model.TotalDealers.ToString();
            ViewData["Unit"] = "Đại lý";
            ViewData["IconClass"] = "fas fa-building";
            ViewData["GradientClass"] = "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)";
            ViewData["ProgressPercent"] = 88;
            ViewData["SubText"] = "<i class=\"fas fa-check-circle me-1\"></i>Đang hoạt động";
        }
        <partial name="_KpiCard" />
    </div>

    <div class="col-xl-3 col-md-6">
        @{
            ViewData["Title"] = "Tổng đơn hàng";
            ViewData["Value"] = Model.TotalOrders.ToString();
            ViewData["Unit"] = "Đơn hàng";
            ViewData["IconClass"] = "fas fa-shopping-cart";
            ViewData["GradientClass"] = "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)";
            ViewData["ProgressPercent"] = 92;
            ViewData["SubText"] = "<i class=\"fas fa-chart-line me-1\"></i>Tất cả thời gian";
        }
        <partial name="_KpiCard" />
    </div>

    <div class="col-xl-3 col-md-6">
        @{
            ViewData["Title"] = "Đơn chờ duyệt";
            ViewData["Value"] = Model.PendingPurchaseOrders.ToString();
            ViewData["Unit"] = "Đơn hàng";
            ViewData["IconClass"] = "fas fa-clock";
            ViewData["GradientClass"] = "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)";
            ViewData["ProgressPercent"] = 45;
            ViewData["SubText"] = "<i class=\"fas fa-exclamation-circle me-1\"></i>Cần xử lý";
        }
        <partial name="_KpiCard" />
    </div>
</div>

<!-- Charts Section -->
<div class="row g-3 mb-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2 text-primary"></i>Doanh số 6 tháng gần nhất</h5>
            </div>
            <div class="card-body">
                <canvas id="salesChart" height="300"></canvas>
                        </div>
                    </div>
                    </div>
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2 text-success"></i>Xu hướng đơn đặt hàng theo tuần</h5>
                </div>
            <div class="card-body">
                <canvas id="ordersChart" height="300"></canvas>
            </div>
            </div>
        </div>
    </div>

<div class="row g-3 mb-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2 text-warning"></i>Phân bổ tồn kho theo thương hiệu</h5>
            </div>
            <div class="card-body">
                <canvas id="inventoryChart" height="300"></canvas>
                        </div>
                    </div>
                    </div>
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0"><i class="fas fa-building me-2 text-info"></i>Top đại lý theo doanh số</h5>
                </div>
            <div class="card-body">
                <canvas id="dealersChart" height="300"></canvas>
            </div>
            </div>
        </div>
    </div>

<!-- Quick Actions -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <a asp-page="/EVMStaff/ProductManagement/Create" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body text-center p-4">
                    <div class="mb-3">
                        <div class="p-3 rounded-circle d-inline-block" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="fas fa-plus-circle fs-2 text-white"></i>
                        </div>
                    </div>
                    <h5 class="mb-2 fw-semibold">Thêm sản phẩm</h5>
                    <p class="text-muted small mb-0">Tạo sản phẩm mới</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a asp-page="/EVMStaff/InventoryManagement/Index" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body text-center p-4">
                    <div class="mb-3">
                        <div class="p-3 rounded-circle d-inline-block" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <i class="fas fa-truck fs-2 text-white"></i>
                        </div>
                    </div>
                    <h5 class="mb-2 fw-semibold">Điều phối tồn kho</h5>
                    <p class="text-muted small mb-0">Quản lý kho hàng</p>
                </div>
            </div>
                </a>
    </div>
    <div class="col-md-3">
        <a asp-page="/EVMStaff/PricingManagement/Index" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body text-center p-4">
                    <div class="mb-3">
                        <div class="p-3 rounded-circle d-inline-block" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <i class="fas fa-tags fs-2 text-white"></i>
                        </div>
                    </div>
                    <h5 class="mb-2 fw-semibold">Quản lý giá</h5>
                    <p class="text-muted small mb-0">Cập nhật giá sản phẩm</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a asp-page="/EVMStaff/UserManagement/Index" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body text-center p-4">
                    <div class="mb-3">
                        <div class="p-3 rounded-circle d-inline-block" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <i class="fas fa-users-cog fs-2 text-white"></i>
                        </div>
                    </div>
                    <h5 class="mb-2 fw-semibold">Quản lý tài khoản</h5>
                    <p class="text-muted small mb-0">Tài khoản đại lý</p>
                </div>
            </div>
                </a>
    </div>
</div>

<!-- Recent Activities & Stats -->
<div class="row g-3">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2 text-primary"></i>Hoạt động gần đây</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    @{
                        ViewData["IconClass"] = "fas fa-plus-circle";
                        ViewData["Title"] = "Sản phẩm mới được thêm";
                        ViewData["Description"] = "VinFast VF e34 đã được thêm vào hệ thống";
                        ViewData["TimeAgo"] = "5 phút trước";
                        ViewData["ColorClass"] = "bg-primary";
                    }
                    <partial name="_ActivityItem" />
                    
                    @{
                        ViewData["IconClass"] = "fas fa-shopping-cart";
                        ViewData["Title"] = "Đơn đặt hàng mới";
                        ViewData["Description"] = "Đại lý ABC đặt 3 xe VinFast VF 8";
                        ViewData["TimeAgo"] = "1 giờ trước";
                        ViewData["ColorClass"] = "bg-success";
                    }
                    <partial name="_ActivityItem" />
                    
                    @{
                        ViewData["IconClass"] = "fas fa-building";
                        ViewData["Title"] = "Đại lý mới";
                        ViewData["Description"] = "Đại lý XYZ đã được đăng ký";
                        ViewData["TimeAgo"] = "3 giờ trước";
                        ViewData["ColorClass"] = "bg-info";
                    }
                    <partial name="_ActivityItem" />
                    
                    @{
                        ViewData["IconClass"] = "fas fa-exclamation-triangle";
                        ViewData["Title"] = "Cảnh báo tồn kho";
                        ViewData["Description"] = "5 sản phẩm có tồn kho thấp";
                        ViewData["TimeAgo"] = "1 ngày trước";
                        ViewData["ColorClass"] = "bg-warning";
                    }
                    <partial name="_ActivityItem" />
                </div>
            </div>
            <div class="card-footer bg-white border-0 text-center py-3">
                <a asp-page="/EVMStaff/SalesReport/Index" class="text-decoration-none small">Xem tất cả <i class="fas fa-arrow-right ms-1"></i></a>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0"><i class="fas fa-tasks me-2 text-warning"></i>Cần xử lý</h5>
            </div>
            <div class="card-body">
                <a asp-page="/PurchaseOrder/Index" class="text-decoration-none">
                    <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom hover-bg-light p-2 rounded">
                        <div class="d-flex align-items-center">
                            <div class="bg-warning bg-opacity-10 p-2 rounded me-3">
                                <i class="fas fa-clock text-warning fs-5"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">Đơn chờ duyệt</div>
                                <small class="text-muted">Cần xử lý</small>
                            </div>
                        </div>
                        <span class="badge bg-warning">@Model.PendingPurchaseOrders</span>
            </div>
                </a>
                <a asp-page="/EVMStaff/InventoryManagement/Index" class="text-decoration-none">
                    <div class="d-flex align-items-center justify-content-between hover-bg-light p-2 rounded">
                        <div class="d-flex align-items-center">
                            <div class="bg-danger bg-opacity-10 p-2 rounded me-3">
                                <i class="fas fa-exclamation-triangle text-danger fs-5"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">Tồn kho thấp</div>
                                <small class="text-muted">Cần bổ sung</small>
                            </div>
                        </div>
                        <span class="badge bg-danger">@Model.LowStockProducts</span>
            </div>
                </a>
    </div>
</div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0"><i class="fas fa-star me-2 text-success"></i>Thống kê tuần</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <small class="fw-semibold">Doanh số</small>
                        <small class="fw-semibold text-success">75%</small>
                    </div>
                    <div class="progress" style="height: 8px; border-radius: 4px;">
                        <div class="progress-bar" style="width: 75%; background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%); border-radius: 4px;"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <small class="fw-semibold">Sản phẩm mới</small>
                        <small class="fw-semibold text-info">60%</small>
                    </div>
                    <div class="progress" style="height: 8px; border-radius: 4px;">
                        <div class="progress-bar" style="width: 60%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); border-radius: 4px;"></div>
                    </div>
                </div>
                <div>
                    <div class="d-flex justify-content-between mb-2">
                        <small class="fw-semibold">Hoàn thành đơn</small>
                        <small class="fw-semibold text-primary">88%</small>
                    </div>
                    <div class="progress" style="height: 8px; border-radius: 4px;">
                        <div class="progress-bar" style="width: 88%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 4px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script>
        $(document).ready(function() {
            console.log('Document ready, bắt đầu khởi tạo biểu đồ...');
            
            // Kiểm tra Chart.js có load được không
            if (typeof Chart === 'undefined') {
                console.error('Chart.js chưa được load!');
                return;
            }
            console.log('Chart.js đã load thành công');
            
            // Khởi tạo các biểu đồ
            initSalesChart();
            initOrdersChart();
            initInventoryChart();
            initDealersChart();
        });

        // Biểu đồ doanh số 6 tháng
        async function initSalesChart() {
            try {
                console.log('Đang tải dữ liệu biểu đồ doanh số...');
                const response = await fetch('/EVMStaff/Dashboard?handler=SalesChartData');
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Dữ liệu nhận được:', data);
                
                const canvas = document.getElementById('salesChart');
                if (!canvas) {
                    console.error('Không tìm thấy canvas element với id salesChart');
                    return;
                }
                const ctx = canvas.getContext('2d');
                console.log('Đang tạo biểu đồ doanh số...');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Doanh số (VND)',
                            data: data.data.map(item => item.revenue),
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2,
                            borderRadius: 4,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Doanh số: ' + new Intl.NumberFormat('vi-VN', {
                                            style: 'currency',
                                            currency: 'VND'
                                        }).format(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('vi-VN', {
                                            style: 'currency',
                                            currency: 'VND',
                                            minimumFractionDigits: 0
                                        }).format(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Lỗi tải dữ liệu biểu đồ doanh số:', error);
            }
        }

        // Biểu đồ xu hướng đơn đặt hàng
        async function initOrdersChart() {
            try {
                console.log('Đang tải dữ liệu biểu đồ đơn đặt hàng...');
                const response = await fetch('/EVMStaff/Dashboard?handler=OrdersChartData');
                console.log('Orders response status:', response.status);
                const data = await response.json();
                console.log('Orders data:', data);
                
                const ctx = document.getElementById('ordersChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Số đơn đặt hàng',
                            data: data.data.map(item => item.orders),
                            borderColor: 'rgba(67, 233, 123, 1)',
                            backgroundColor: 'rgba(67, 233, 123, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(67, 233, 123, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const dataIndex = context.dataIndex;
                                        const item = data.data[dataIndex];
                                        return [
                                            'Đơn hàng: ' + item.orders,
                                            'Doanh số: ' + new Intl.NumberFormat('vi-VN', {
                                                style: 'currency',
                                                currency: 'VND'
                                            }).format(item.revenue)
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Lỗi tải dữ liệu biểu đồ đơn đặt hàng:', error);
            }
        }

        // Biểu đồ phân bổ tồn kho theo thương hiệu
        async function initInventoryChart() {
            try {
                const response = await fetch('/EVMStaff/Dashboard?handler=InventoryChartData');
                const data = await response.json();
                
                const ctx = document.getElementById('inventoryChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(item => item.brandName),
                        datasets: [{
                            data: data.map(item => item.totalQuantity),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 205, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)',
                                'rgba(255, 159, 64, 0.8)',
                                'rgba(199, 199, 199, 0.8)',
                                'rgba(83, 102, 255, 0.8)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 205, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(199, 199, 199, 1)',
                                'rgba(83, 102, 255, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const dataIndex = context.dataIndex;
                                        const item = data[dataIndex];
                                        return [
                                            context.label + ': ' + context.parsed + ' sản phẩm',
                                            'Giá trị: ' + new Intl.NumberFormat('vi-VN', {
                                                style: 'currency',
                                                currency: 'VND'
                                            }).format(item.totalValue)
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Lỗi tải dữ liệu biểu đồ tồn kho:', error);
            }
        }

        // Biểu đồ top đại lý theo doanh số
        async function initDealersChart() {
            try {
                const response = await fetch('/EVMStaff/Dashboard?handler=DealersChartData');
                const data = await response.json();
                
                const ctx = document.getElementById('dealersChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(item => item.dealerName.length > 15 ? 
                            item.dealerName.substring(0, 15) + '...' : item.dealerName),
                        datasets: [{
                            label: 'Doanh số (VND)',
                            data: data.map(item => item.totalSales),
                            backgroundColor: 'rgba(79, 172, 254, 0.8)',
                            borderColor: 'rgba(79, 172, 254, 1)',
                            borderWidth: 2,
                            borderRadius: 4,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const dataIndex = context.dataIndex;
                                        const item = data[dataIndex];
                                        return [
                                            'Đại lý: ' + item.dealerName,
                                            'Doanh số: ' + new Intl.NumberFormat('vi-VN', {
                                                style: 'currency',
                                                currency: 'VND'
                                            }).format(context.parsed.x),
                                            'Đơn hàng: ' + item.orderCount
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('vi-VN', {
                                            style: 'currency',
                                            currency: 'VND',
                                            minimumFractionDigits: 0
                                        }).format(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Lỗi tải dữ liệu biểu đồ đại lý:', error);
            }
        }
    </script>
}

