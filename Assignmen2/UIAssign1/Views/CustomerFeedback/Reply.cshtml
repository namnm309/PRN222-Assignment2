@model BusinessLayer.ViewModels.FeedbackViewModel
@{
    ViewData["Title"] = "Trả lời phản hồi";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-reply mr-2"></i>Trả lời phản hồi khách hàng
                    </h3>
                    <div class="card-tools">
                        <a href="@Url.Action("Detail", new { id = Model.Id })" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Original Feedback -->
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-comment mr-2"></i>Phản hồi gốc
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-sm-6">
                                            <strong>Khách hàng:</strong> @Model.CustomerName
                                        </div>
                                        <div class="col-sm-6">
                                            <strong>Ngày gửi:</strong> @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-sm-6">
                                            <strong>Sản phẩm:</strong> @Model.ProductName
                                        </div>
                                        <div class="col-sm-6">
                                            <strong>Đánh giá:</strong> 
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                if (i <= Model.Rating)
                                                {
                                                    <i class="fas fa-star text-warning"></i>
                                                }
                                                else
                                                {
                                                    <i class="far fa-star text-muted"></i>
                                                }
                                            }
                                            (@Model.Rating/5)
                                        </div>
                                    </div>

                                    <div class="feedback-content">
                                        <strong>Nội dung:</strong>
                                        <div class="mt-2 p-3 bg-light rounded">
                                            @if (!string.IsNullOrEmpty(Model.Comment))
                                            {
                                                @Model.Comment
                                            }
                                            else
                                            {
                                                <span class="text-muted">Không có nội dung phản hồi</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <!-- Reply Form -->
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-edit mr-2"></i>Trả lời phản hồi
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form method="post" action="@Url.Action("Reply", new { id = Model.Id })">
                                        @Html.AntiForgeryToken()
                                        
                                        <div class="form-group">
                                            <label for="replyMessage">Nội dung trả lời <span class="text-danger">*</span></label>
                                            <textarea class="form-control" id="replyMessage" name="replyMessage" 
                                                      rows="8" placeholder="Nhập nội dung trả lời cho khách hàng..." required></textarea>
                                            <small class="form-text text-muted">
                                                Hãy trả lời một cách chuyên nghiệp và hữu ích cho khách hàng.
                                            </small>
                                        </div>

                                        <div class="form-group">
                                            <label for="replyType">Loại trả lời</label>
                                            <select class="form-control" id="replyType" name="replyType">
                                                <option value="general">Trả lời chung</option>
                                                <option value="technical">Hỗ trợ kỹ thuật</option>
                                                <option value="complaint">Xử lý khiếu nại</option>
                                                <option value="compliment">Cảm ơn đánh giá</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label for="priority">Độ ưu tiên</label>
                                            <select class="form-control" id="priority" name="priority">
                                                <option value="low">Thấp</option>
                                                <option value="medium" selected>Trung bình</option>
                                                <option value="high">Cao</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="markAsResolved" name="markAsResolved" value="true">
                                                <label class="form-check-label" for="markAsResolved">
                                                    Đánh dấu là đã xử lý
                                                </label>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="sendEmail" name="sendEmail" value="true" checked>
                                                <label class="form-check-label" for="sendEmail">
                                                    Gửi email thông báo cho khách hàng
                                                </label>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-paper-plane"></i> Gửi trả lời
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="previewReply()">
                                                <i class="fas fa-eye"></i> Xem trước
                                            </button>
                                            <a href="@Url.Action("Detail", new { id = Model.Id })" class="btn btn-outline-secondary">
                                                <i class="fas fa-times"></i> Hủy
                                            </a>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reply Templates -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-lightbulb mr-2"></i>Mẫu trả lời nhanh
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-outline-primary btn-block mb-2" 
                                                    onclick="insertTemplate('thank')">
                                                Cảm ơn đánh giá
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-outline-primary btn-block mb-2" 
                                                    onclick="insertTemplate('technical')">
                                                Hỗ trợ kỹ thuật
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-outline-primary btn-block mb-2" 
                                                    onclick="insertTemplate('complaint')">
                                                Xử lý khiếu nại
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-outline-primary btn-block mb-2" 
                                                    onclick="insertTemplate('followup')">
                                                Theo dõi
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function previewReply() {
            var message = $('#replyMessage').val();
            if (message.trim() === '') {
                alert('Vui lòng nhập nội dung trả lời trước khi xem trước.');
                return;
            }
            
            var previewWindow = window.open('', '_blank', 'width=600,height=400');
            var content = `
                <html>
                <head>
                    <title>Xem trước trả lời</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                        .content { line-height: 1.6; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h3>Trả lời phản hồi khách hàng</h3>
                        <p><strong>Khách hàng:</strong> @Model.CustomerName</p>
                        <p><strong>Ngày gửi:</strong> @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                    <div class="content">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                </body>
                </html>
            `;
            previewWindow.document.write(content);
            previewWindow.document.close();
        }

        function insertTemplate(type) {
            var templates = {
                'thank': 'Xin chào @Model.CustomerName,\n\nCảm ơn bạn đã dành thời gian đánh giá sản phẩm của chúng tôi. Chúng tôi rất trân trọng ý kiến của bạn và sẽ tiếp tục cải thiện chất lượng dịch vụ.\n\nTrân trọng,\nĐội ngũ hỗ trợ khách hàng',
                'technical': 'Xin chào @Model.CustomerName,\n\nCảm ơn bạn đã liên hệ với chúng tôi. Chúng tôi đã nhận được phản hồi của bạn và đang xem xét vấn đề kỹ thuật mà bạn đề cập.\n\nChúng tôi sẽ liên hệ lại với bạn trong thời gian sớm nhất để hỗ trợ giải quyết vấn đề.\n\nTrân trọng,\nĐội ngũ kỹ thuật',
                'complaint': 'Xin chào @Model.CustomerName,\n\nChúng tôi rất xin lỗi về những bất tiện mà bạn đã gặp phải. Chúng tôi đang xem xét nghiêm túc phản hồi của bạn và sẽ có biện pháp khắc phục phù hợp.\n\nChúng tôi cam kết cải thiện chất lượng dịch vụ để phục vụ bạn tốt hơn.\n\nTrân trọng,\nĐội ngũ quản lý',
                'followup': 'Xin chào @Model.CustomerName,\n\nChúng tôi muốn theo dõi tình hình sau khi bạn đã sử dụng sản phẩm/dịch vụ của chúng tôi. Bạn có hài lòng với trải nghiệm không?\n\nNếu có bất kỳ thắc mắc nào, vui lòng liên hệ với chúng tôi.\n\nTrân trọng,\nĐội ngũ chăm sóc khách hàng'
            };
            
            $('#replyMessage').val(templates[type]);
        }
    </script>
}
