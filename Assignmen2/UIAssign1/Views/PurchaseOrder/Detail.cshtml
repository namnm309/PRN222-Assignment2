@model BusinessLayer.ViewModels.PurchaseOrderViewModel
@using BusinessLayer.Enums

@{
    ViewData["Title"] = $"Chi tiết đơn đặt hàng #{Model.OrderNumber}";
    Layout = "_DashboardLayout";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-file-alt me-2"></i>Chi tiết đơn đặt hàng #@Model.OrderNumber</h2>
    <a href="@Url.Action("Index")" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i> Quay lại danh sách
    </a>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row">
    <!-- Main Info -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Thông tin đơn hàng</h5>
                @switch (Model.Status)
                {
                    case PurchaseOrderStatus.Pending:
                        <span class="badge bg-warning text-dark fs-6">Chờ duyệt</span>
                        break;
                    case PurchaseOrderStatus.Approved:
                        <span class="badge bg-success fs-6">Đã duyệt</span>
                        break;
                    case PurchaseOrderStatus.Rejected:
                        <span class="badge bg-danger fs-6">Bị từ chối</span>
                        break;
                    case PurchaseOrderStatus.InTransit:
                        <span class="badge bg-info fs-6">Đang vận chuyển</span>
                        break;
                    case PurchaseOrderStatus.Delivered:
                        <span class="badge bg-primary fs-6">Đã giao hàng</span>
                        break;
                    case PurchaseOrderStatus.Cancelled:
                        <span class="badge bg-secondary fs-6">Đã hủy</span>
                        break;
                }
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Thông tin cơ bản</h6>
                        <p><strong>Mã đơn:</strong> @Model.OrderNumber</p>
                        <p><strong>Đại lý:</strong> @Model.DealerName</p>
                        <p><strong>Người đặt:</strong> @Model.RequestedByName</p>
                        <p><strong>Ngày đặt:</strong> @Model.RequestedDate.ToString("dd/MM/yyyy HH:mm")</p>
                        @if (Model.ApprovedDate.HasValue)
                        {
                            <p><strong>Ngày duyệt:</strong> @Model.ApprovedDate.Value.ToString("dd/MM/yyyy HH:mm")</p>
                            <p><strong>Người duyệt:</strong> @Model.ApprovedByName</p>
                        }
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Sản phẩm & Số lượng</h6>
                        <div class="product-info p-3 border rounded">
                            <h6 class="mb-2">@Model.ProductName</h6>
                            <p class="mb-1"><strong>Số lượng:</strong> <span class="badge bg-info">@Model.RequestedQuantity.ToString("N0")</span></p>
                            <p class="mb-1"><strong>Đơn giá:</strong> @Model.UnitPrice.ToString("N0") VNĐ</p>
                            <p class="mb-0"><strong>Tổng tiền:</strong> <span class="text-success fw-bold">@Model.TotalAmount.ToString("N0") VNĐ</span></p>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Lý do đặt hàng</h6>
                        <p class="border p-3 rounded bg-light">@Model.Reason</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">Thông tin giao hàng</h6>
                        @if (Model.ExpectedDeliveryDate.HasValue)
                        {
                            <p><strong>Ngày giao dự kiến:</strong> @Model.ExpectedDeliveryDate.Value.ToString("dd/MM/yyyy")</p>
                        }
                        @if (Model.ActualDeliveryDate.HasValue)
                        {
                            <p><strong>Ngày giao thực tế:</strong> @Model.ActualDeliveryDate.Value.ToString("dd/MM/yyyy")</p>
                        }
                    </div>
                </div>

                @if (!string.IsNullOrWhiteSpace(Model.Notes))
                {
                    <hr>
                    <h6 class="text-primary mb-3">Ghi chú</h6>
                    <p class="border p-3 rounded bg-light">@Html.Raw(Model.Notes.Replace("\n", "<br>"))</p>
                }

                @if (!string.IsNullOrWhiteSpace(Model.RejectReason))
                {
                    <hr>
                    <h6 class="text-danger mb-3">Lý do từ chối</h6>
                    <div class="alert alert-danger">@Model.RejectReason</div>
                }
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Thao tác</h6>
            </div>
            <div class="card-body">
                @{
                    var userRole = ViewBag.UserRole.ToString();
                    var isAdmin = userRole == "Admin" || userRole == "EVMStaff";
                    var isDealer = userRole == "DealerManager" || userRole == "DealerStaff";
                }

                @if (Model.Status == PurchaseOrderStatus.Pending)
                {
                    @if (isAdmin)
                    {
                        <!-- Admin/EVM Actions -->
                        <button type="button" class="btn btn-success w-100 mb-2" data-bs-toggle="modal" data-bs-target="#approveModal">
                            <i class="fas fa-check me-1"></i> Duyệt đơn
                        </button>
                        <button type="button" class="btn btn-danger w-100 mb-2" data-bs-toggle="modal" data-bs-target="#rejectModal">
                            <i class="fas fa-times me-1"></i> Từ chối
                        </button>
                    }
                    
                    @if (isDealer)
                    {
                        <!-- Dealer Actions -->
                        <button type="button" class="btn btn-warning w-100 mb-2" data-bs-toggle="modal" data-bs-target="#cancelModal">
                            <i class="fas fa-ban me-1"></i> Hủy đơn
                        </button>
                    }
                }

                @if (isAdmin && Model.Status == PurchaseOrderStatus.Approved)
                {
                    <button type="button" class="btn btn-info w-100 mb-2" data-bs-toggle="modal" data-bs-target="#transitModal">
                        <i class="fas fa-truck me-1"></i> Bắt đầu vận chuyển
                    </button>
                }

                @if (isAdmin && Model.Status == PurchaseOrderStatus.InTransit)
                {
                    <button type="button" class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#deliveryModal">
                        <i class="fas fa-check-circle me-1"></i> Xác nhận giao hàng
                    </button>
                }

                @if (Model.Status != PurchaseOrderStatus.Delivered && Model.Status != PurchaseOrderStatus.Cancelled && isAdmin)
                {
                    <button type="button" class="btn btn-secondary w-100" data-bs-toggle="modal" data-bs-target="#cancelAdminModal">
                        <i class="fas fa-ban me-1"></i> Hủy đơn (Admin)
                    </button>
                }
            </div>
        </div>

        <!-- Timeline -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-history me-2"></i>Tiến trình</h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item active">
                        <div class="timeline-marker bg-success"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Tạo đơn</h6>
                            <small class="text-muted">@Model.RequestedDate.ToString("dd/MM/yyyy HH:mm")</small>
                        </div>
                    </div>
                    
                    <div class="timeline-item @(Model.Status >= PurchaseOrderStatus.Approved || Model.Status == PurchaseOrderStatus.Rejected ? "active" : "")">
                        <div class="timeline-marker @(Model.Status >= PurchaseOrderStatus.Approved ? "bg-success" : Model.Status == PurchaseOrderStatus.Rejected ? "bg-danger" : "bg-secondary")"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">@(Model.Status == PurchaseOrderStatus.Rejected ? "Từ chối" : "Duyệt đơn")</h6>
                            @if (Model.ApprovedDate.HasValue)
                            {
                                <small class="text-muted">@Model.ApprovedDate.Value.ToString("dd/MM/yyyy HH:mm")</small>
                            }
                        </div>
                    </div>
                    
                    @if (Model.Status != PurchaseOrderStatus.Rejected && Model.Status != PurchaseOrderStatus.Cancelled)
                    {
                        <div class="timeline-item @(Model.Status >= PurchaseOrderStatus.InTransit ? "active" : "")">
                            <div class="timeline-marker @(Model.Status >= PurchaseOrderStatus.InTransit ? "bg-success" : "bg-secondary")"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Vận chuyển</h6>
                            </div>
                        </div>
                        
                        <div class="timeline-item @(Model.Status == PurchaseOrderStatus.Delivered ? "active" : "")">
                            <div class="timeline-marker @(Model.Status == PurchaseOrderStatus.Delivered ? "bg-success" : "bg-secondary")"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Giao hàng</h6>
                                @if (Model.ActualDeliveryDate.HasValue)
                                {
                                    <small class="text-muted">@Model.ActualDeliveryDate.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
@if (isAdmin && Model.Status == PurchaseOrderStatus.Pending)
{
    <!-- Approve Modal -->
    <div class="modal fade" id="approveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="Approve" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="modal-header">
                        <h5 class="modal-title">Duyệt đơn đặt hàng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Ngày giao dự kiến</label>
                            <input name="expectedDeliveryDate" type="date" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ghi chú (tùy chọn)</label>
                            <textarea name="notes" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-success">Duyệt đơn</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div class="modal fade" id="rejectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="Reject" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="modal-header">
                        <h5 class="modal-title">Từ chối đơn đặt hàng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Lý do từ chối *</label>
                            <textarea name="rejectReason" class="form-control" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-danger">Từ chối đơn</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@if (isAdmin && Model.Status == PurchaseOrderStatus.Approved)
{
    <!-- Transit Modal -->
    <div class="modal fade" id="transitModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="UpdateStatus" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <input type="hidden" name="status" value="@((int)PurchaseOrderStatus.InTransit)" />
                    <div class="modal-header">
                        <h5 class="modal-title">Bắt đầu vận chuyển</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Xác nhận bắt đầu vận chuyển đơn hàng này?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-info">Bắt đầu vận chuyển</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@if (isAdmin && Model.Status == PurchaseOrderStatus.InTransit)
{
    <!-- Delivery Modal -->
    <div class="modal fade" id="deliveryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="UpdateStatus" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <input type="hidden" name="status" value="@((int)PurchaseOrderStatus.Delivered)" />
                    <div class="modal-header">
                        <h5 class="modal-title">Xác nhận giao hàng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Ngày giao thực tế</label>
                            <input name="actualDeliveryDate" type="date" class="form-control" />
                            <div class="form-text">Để trống sẽ sử dụng ngày hiện tại</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Xác nhận giao hàng</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- Cancel Modals -->
@if (isDealer && Model.Status == PurchaseOrderStatus.Pending)
{
    <div class="modal fade" id="cancelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="Cancel" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="modal-header">
                        <h5 class="modal-title">Hủy đơn đặt hàng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Bạn có chắc chắn muốn hủy đơn đặt hàng này?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
                        <button type="submit" class="btn btn-warning">Hủy đơn</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@if (isAdmin)
{
    <div class="modal fade" id="cancelAdminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="UpdateStatus" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <input type="hidden" name="status" value="@((int)PurchaseOrderStatus.Cancelled)" />
                    <div class="modal-header">
                        <h5 class="modal-title">Hủy đơn đặt hàng (Admin)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Bạn có chắc chắn muốn hủy đơn đặt hàng này?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
                        <button type="submit" class="btn btn-secondary">Hủy đơn</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Styles {
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-marker {
            position: absolute;
            left: -25px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #fff;
        }
        
        .timeline-item.active .timeline-marker {
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
        }
        
        .product-info {
            background-color: #f8f9fa;
        }
    </style>
}
